generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleCode {
  ADMIN_TECH
  SUPERVISOR
  AGENT_OPERATIVE
}

enum AgentStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  ERROR
}

enum ConversationStatus {
  OPEN
  CLOSED
  PENDING
}

enum MessageDirection {
  IN
  OUT
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  DOC
  AUDIO
}

enum BackupType {
  FULL
  INCREMENTAL
}

enum BackupStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum AIMessageRole {
  system
  user
  assistant
  tool
}

model User {
  id                String            @id @default(uuid()) @db.Uuid
  email             String            @unique @db.VarChar(255)
  passwordHash      String            @map("password_hash")
  fullName          String            @map("full_name") @db.VarChar(255)
  isActive          Boolean           @default(true) @map("is_active")
  mfaEnabled        Boolean           @default(false) @map("mfa_enabled")
  mfaSecret         String?           @map("mfa_secret")
  mfaRecoveryCodes  Json?             @map("mfa_recovery_codes")
  createdAt         DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  roles             UserRole[]
  agentAccess       UserAgentAccess[]
  backupJobs        BackupJob[]       @relation("BackupRequestedBy")
  auditLogs         AuditLog[]        @relation("AuditActor")
  aiSessions        AISession[]

  @@map("users")
}

model Role {
  id    Int       @id @default(autoincrement())
  code  RoleCode  @unique
  users UserRole[]

  @@map("roles")
}

model UserRole {
  userId String @map("user_id") @db.Uuid
  roleId Int    @map("role_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model WhatsappAgent {
  id              String            @id @default(uuid()) @db.Uuid
  code            String            @unique @db.VarChar(50)
  displayName     String            @map("display_name") @db.VarChar(100)
  phoneNumber     String            @map("phone_number") @db.VarChar(30)
  providerPhoneId String            @map("provider_phone_id") @db.VarChar(100)
  status          AgentStatus       @default(DISCONNECTED)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  userAccess      UserAgentAccess[]
  conversations   Conversation[]
  aiSessions      AISession[]

  @@map("whatsapp_agents")
}

model UserAgentAccess {
  userId  String        @map("user_id") @db.Uuid
  agentId String        @map("agent_id") @db.Uuid
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent   WhatsappAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@id([userId, agentId])
  @@map("user_agent_access")
}

model Conversation {
  id            String             @id @default(uuid()) @db.Uuid
  agentId       String             @map("agent_id") @db.Uuid
  customerWaId  String             @map("customer_wa_id") @db.VarChar(100)
  customerName  String?            @map("customer_name") @db.VarChar(255)
  status        ConversationStatus @default(OPEN)
  lastMessageAt DateTime?          @map("last_message_at") @db.Timestamptz(6)
  createdAt     DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  agent         WhatsappAgent      @relation(fields: [agentId], references: [id])
  messages      Message[]

  @@index([agentId, status])
  @@index([lastMessageAt])
  @@map("conversations")
}

model Message {
  id                String           @id @default(uuid()) @db.Uuid
  conversationId    String           @map("conversation_id") @db.Uuid
  direction         MessageDirection
  messageType       MessageType      @map("message_type")
  textContent       String?          @map("text_content")
  mediaUrl          String?          @map("media_url")
  mimeType          String?          @map("mime_type") @db.VarChar(100)
  providerMessageId String?          @map("provider_message_id") @db.VarChar(150)
  sentAt            DateTime?        @map("sent_at") @db.Timestamptz(6)
  deliveredAt       DateTime?        @map("delivered_at") @db.Timestamptz(6)
  readAt            DateTime?        @map("read_at") @db.Timestamptz(6)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([providerMessageId])
  @@map("messages")
}

model BackupJob {
  id           String       @id @default(uuid()) @db.Uuid
  requestedBy  String?      @map("requested_by") @db.Uuid
  backupType   BackupType   @map("backup_type")
  status       BackupStatus
  startedAt    DateTime?    @map("started_at") @db.Timestamptz(6)
  finishedAt   DateTime?    @map("finished_at") @db.Timestamptz(6)
  artifactPath String?      @map("artifact_path")
  checksum     String?      @db.VarChar(128)
  errorMessage String?      @map("error_message")
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  requester    User?        @relation("BackupRequestedBy", fields: [requestedBy], references: [id])

  @@index([status, createdAt])
  @@map("backup_jobs")
}

model AuditLog {
  id          BigInt    @id @default(autoincrement())
  actorUserId String?   @map("actor_user_id") @db.Uuid
  action      String    @db.VarChar(120)
  resourceType String   @map("resource_type") @db.VarChar(60)
  resourceId  String?   @map("resource_id") @db.VarChar(120)
  payload     Json?
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  actor       User?     @relation("AuditActor", fields: [actorUserId], references: [id])

  @@index([actorUserId, createdAt])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

model AISession {
  id            String        @id @default(uuid()) @db.Uuid
  userId        String        @map("user_id") @db.Uuid
  agentScopeId  String?       @map("agent_scope_id") @db.Uuid
  modelProvider String        @map("model_provider") @db.VarChar(40)
  modelName     String        @map("model_name") @db.VarChar(120)
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  user          User          @relation(fields: [userId], references: [id])
  agentScope    WhatsappAgent? @relation(fields: [agentScopeId], references: [id])
  messages      AIMessage[]

  @@index([userId, createdAt])
  @@index([agentScopeId])
  @@map("ai_sessions")
}

model AIMessage {
  id          String       @id @default(uuid()) @db.Uuid
  aiSessionId String       @map("ai_session_id") @db.Uuid
  role        AIMessageRole
  content     String
  meta        Json?
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  session     AISession    @relation(fields: [aiSessionId], references: [id], onDelete: Cascade)

  @@index([aiSessionId, createdAt])
  @@map("ai_messages")
}
